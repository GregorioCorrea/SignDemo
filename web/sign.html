<!doctype html>
<html lang="es">
<meta charset="utf-8">
<title>Firmar documento</title>
<style>body{font-family:system-ui;margin:24px} canvas{border:1px solid #ccc;max-width:100%}</style>
<h1>Firmar documento</h1>
<div id="viewer"></div>
<label><input type="checkbox" id="consent"> Acepto firmar este documento</label>
<br><br>
<canvas id="sig" width="600" height="200"></canvas><br>
<button id="btnClear">Limpiar</button>
<button id="btnSign">Firmar</button>
<pre id="out"></pre>

<script type="module">
import SignaturePad from "https://cdn.skypack.dev/signature_pad";
const pad = new SignaturePad(document.getElementById('sig'));
document.getElementById('btnClear').onclick = () => pad.clear();

const params = new URLSearchParams(location.search);
const token = params.get('token');
const API = 'https://func-signdemo.azurewebsites.net/api';

async function loadPdf() {
  const r = await fetch(`${API}/getPdfSas?token=${encodeURIComponent(token)}`).then(r=>r.json());
  document.getElementById('viewer').innerHTML = `<object data="${r.url}" type="application/pdf" width="100%" height="600"></object>`;
}
loadPdf();

document.getElementById('btnSign').onclick = async () => {
  if (!document.getElementById('consent').checked) return alert('Falta consentimiento');
  if (pad.isEmpty()) return alert('Falta la firma');

  const body = {
    token,
    consent: true,
    signaturePngBase64: pad.toDataURL('image/png').split(',')[1],
    signatureStrokes: pad.toData(),
    userAgent: navigator.userAgent
  };
  const res = await fetch(`${API}/sign`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) })
    .then(r=>r.json());
  document.getElementById('out').textContent = JSON.stringify(res, null, 2);
};
</script>
</html>
